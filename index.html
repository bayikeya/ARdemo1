<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AR 避難ルートデモ</title>
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.min.js"></script>
</head>
<body style="margin:0; overflow:hidden;">
  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    arjs="sourceType: webcam; trackingMethod: best; debugUIEnabled: false;">

    <!-- GPSカメラ -->
    <a-camera gps-camera rotation-reader></a-camera>

  </a-scene>

  <script>
    // マップマッチング済みルート座標の例（緯度経度）
    const routeCoords = [
      { lat: 35.69294944366341, lon: 140.05094266070145 },
      { lat: 35.693316213516184, lon: 140.0509968528988 },
      { lat: 35.69340668315388,   lon: 140.0503314931425 },
      { lat: 35.692905181172925,  lon:  140.05023980492732 },
      { lat: 35.69283938565963,   lon:  140.0508309494168 }
    ];

    // シーン取得
    const sceneEl = document.querySelector("a-scene");

    // GPSが更新されたタイミングで描画
    sceneEl.addEventListener("loaded", () => {
      const threeScene = sceneEl.object3D;
      const cameraEl = document.querySelector("[gps-camera]");

      cameraEl.addEventListener("gps-camera-update-position", (e) => {
        const userLat = e.detail.position.latitude;
        const userLon = e.detail.position.longitude;

        // 緯度経度を Vector3 に変換
        function latLonToVector3(lat, lon, userLat, userLon) {
          const R = 6378137; // 地球半径(m)
          const dLat = (lat - userLat) * Math.PI/180;
          const dLon = (lon - userLon) * Math.PI/180;
          const x = dLon * R * Math.cos(userLat * Math.PI/180);
          const z = dLat * R;
          return new THREE.Vector3(x, 0.5, -z); // y=0.5で少し浮かせる
        }

        // ルートを Vector3 に変換
        const points = routeCoords.map(p => latLonToVector3(p.lat, p.lon, userLat, userLon));

        // Catmull-Rom 曲線で滑らかにする
        const curve = new THREE.CatmullRomCurve3(points);
        const geometry = new THREE.BufferGeometry().setFromPoints(curve.getPoints(100));
        const material = new THREE.LineBasicMaterial({ color: 0x00ff00, linewidth: 5 });
        const line = new THREE.Line(geometry, material);

        threeScene.add(line);

      }, { once: true }); // 初回GPS取得で描画
    });
  </script>
</body>
</html>
